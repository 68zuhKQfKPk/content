import traceback
from enum import Enum

from CommonServerPython import *


class Status(Enum):
    SUSPICIOUS = 'Suspicious'
    BENIGN = 'Benign'
    UNKNOWN = 'Unknown'


STATUS_TO_COLOR = {
    Status.SUSPICIOUS: "ðŸ”´",
    Status.BENIGN: "ðŸŸ¢",
    Status.UNKNOWN: "âšª"
}


class Finding:
    label: str
    status: Status

    def __init__(self, name: str, value: dict):
        self.name = name
        self.label = value.get('Label', f'{self.name} (missing label value)')
        self.status = Status(value.get('Status', Status.UNKNOWN.value))

    def to_summary_line(self) -> tuple[str, str]:
        return self.label, f'{STATUS_TO_COLOR[self.status]} {self.status.value.title()}'


def get_findings(malware_findings_context: dict) -> List[Finding]:
    findings = []
    for name, value in malware_findings_context.items():
        if isinstance(value, list):  # when running the script for the second time, values are put in lists.
            value = value[-1]  # solves for one or multiple values
        findings.append(Finding(name, value))
    return findings


def html_wrap(tag: str, content: str):
    return f'<{tag}>{content}</th>'


def html_wrap_bgcolor(content: str):
    return f'<tr bgcolor="#FFFFFF">{content}</tr>'


def findings_to_command_results(findings: List[Finding]) -> CommandResults:
    outputs = tuple(finding.to_summary_line() for finding in findings)
    html_prefix = f'<table style="table-layout:auto" style="width:75%" ' \
                  f'cellspacing="3" bgcolor="#000000" text-align:center; >'
    html_title = html_wrap_bgcolor(html_wrap('th', 'Label') + html_wrap('th', 'Status'))

    html_body = ''.join(
        html_wrap_bgcolor(html_wrap('td', label) + html_wrap('td', status)) for (label, status) in outputs
    )
    html = ''.join((html_prefix, html_title, html_body))
    return CommandResults(
        outputs_prefix='FindingsTable',
        outputs=outputs,
        readable_output_format=EntryFormat.HTML,
        readable_output=html,
    )


def main():
    try:
        malware_context = demisto.callingContext \
            .get('context', {}).get('ExecutionContext', {}).get('MalwareFinding', {}).get('ContextFinding', {})
        return_results(findings_to_command_results(get_findings(malware_context)))
    except Exception as e:
        demisto.error(traceback.format_exc())  # print the traceback
        return_error(f'Failed to execute FindingsToTable. Error: {str(e)}')


if __name__ in ['__main__', '__builtin__', 'builtins']:
    main()
